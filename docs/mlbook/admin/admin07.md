# 触发器逻辑
### 概述
---------------
&emsp;&emsp;触发器是一种用于响应事件或满足特定条件的自动化机制。它们允许开发人员根据预定的触发条件，如数据更新、时间触发或外部事件触发，执行相应的操作或启动流程。触发器的灵活性和自动化能力使其成为低代码平台中强大而实用的功能，方便开发人员轻松构建自动化流程和响应事件，提高工作效率和准确性。

### 应用场景
---------------
* 数据同步与集成：当源数据发生更改时，触发器可以自动将数据同步到其他系统或应用程序，实现数据的实时更新和一致性。  
* 通知和提醒：触发器可以用于发送通知和提醒，例如，当特定事件发生时，如用户注册、订单状态更新等，触发器可以自动发送电子邮件或短信通知相关人员。  
* 数据验证和规则执行：触发器可以用于验证数据的有效性并执行相关规则。例如，当数据满足特定条件时，触发器可以自动执行计算、更新字段或发送警报。

### 添加触发器
---------------
进入系统管理 - 触发器，点击页面右上角的 [添加] 按钮  
![添加触发器](https://mldocs.ks3-cn-beijing.ksyuncs.com/%E8%A7%A6%E5%8F%91%E5%99%A8%E9%80%BB%E8%BE%91/%E6%B7%BB%E5%8A%A0%E8%A7%A6%E5%8F%91%E5%99%A8.png)

标注的区域分别为：  
1.根据需要选择合适触发器类型；  
2.选择触发源实体，即此触发器通过选择的实体触发；  
3.触发器名称；  
选择/填写完成后点击 [确定] 按钮，系统将进入下一步对触发器进行完整配置。

### 触发器配置
---------------
![触发器配置](https://mldocs.ks3-cn-beijing.ksyuncs.com/%E8%A7%A6%E5%8F%91%E5%99%A8%E9%80%BB%E8%BE%91/%E8%A7%A6%E5%8F%91%E5%99%A8%E9%85%8D%E7%BD%AE.png)

标注的区域分别为：  
1.源实体：触发器所关联的实体类型；  
2.触发动作：触发器何时被触发。当（源实体记录）发生指定“动作”时执行该触发器；  
3.过滤条件：触发器触发的条件。只有满足指定条件的实体操作才会触发该触发器。  
4.执行操作：触发器类型  
5.执行内容：定义触发器执行操作的具体内容。不同的触发器内容可配置的内容也不同，例如，如果执行操作是发送电子邮件通知，则执行内容可以包括电子邮件的收件人、主题和正文。  
6.执行优先级：触发器在发生多个触发事件时的执行顺序。较高的优先级意味着触发器将在其他触发器之前被执行。  
7.立即执行：指触发器是否应立即执行操作。如果立即执行，则当前满足触发条件的数据将会立即执行操作。（仅部分触发器支持） 

**更新指定字段时执行**  
&emsp;&emsp;部分触发器支持配置“更新”指定字段时执行，包括 数据校验、发送通知、新建动态、回调 URL。

**定期执行**  
&emsp;&emsp;触发器除了在特定动作下触发执行，也可以被“定期执行”。对于那些没有合适触发时机或需要定期触发的业务（动作）特别有用（例如发送客户生日提醒）。  
注意：定期执行将会对 源实体中 所有数据执行操作，设置的执行周期请勿过于频繁！
![定期执行](https://mldocs.ks3-cn-beijing.ksyuncs.com/%E8%A7%A6%E5%8F%91%E5%99%A8%E9%80%BB%E8%BE%91/%E5%AE%9A%E6%9C%9F%E6%89%A7%E8%A1%8C.png)

**级联执行**
&emsp;&emsp;某些触发器可能会引起级联执行，例如 A 触发器用于更新某实体字段值，当某实体字段值被更新后，会被动触发“更新”动作，从而引起 B 触发器（若有）执行，B 触发器又可能引起 C 触发器（若有）执行… 简而言之，无论“更新”动作是如何发生（如手动更新、API 更新、触发器更新等），其对应的触发器都会被执行。

### 触发器类型
---------------
&emsp;&emsp;我们提供了多样化的触发器类型，以满足各种业务场景的需求。未来版本中我们还将推出更多的触发器选项，以满足更多的业务需求。

触发器类型包括：  
字段更新，字段聚台，数据效验，发送通知，自动审批，自动撤销审批，自动分配，自动共享，自动取消共享，自动删除，回调URL

### 不同类型触发器配置操作
---------------
### 字段更新   
&emsp;&emsp;设置当指定字段的数值发生更改时触发的操作。可以定义新的数值、清空字段或更新其他相关字段等。例如，当某个订单的状态字段更改为"已发货"时，可以自动更新发货日期字段并发送通知给相关方。

**配置触发器**
![字段更新](https://mldocs.ks3-cn-beijing.ksyuncs.com/%E8%A7%A6%E5%8F%91%E5%99%A8%E9%80%BB%E8%BE%91/%E5%AD%97%E6%AE%B5%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE%E8%A7%A6%E5%8F%91%E5%99%A8.png)

标注的区域分别为：  
1.目标实体：指定字段更新触发器要应用于的实体对象。源实体与目标实体通过 一对一引用 关联，只有存在关联关系的实体才能被选择。  
2.更新规则：根据业务需要设置“更新方式”、“源字段”（或“计算公式”），系统会将结果自动填写到“目标字段”中。  

更新方式：  
* 字段值更新：根据特定字段的新值来更新目标字段。可以将源字段的值直接复制到目标字段，以保持一致性。  
* 固定值更新：将一个固定的值分配给目标字段。这在需要将特定值应用于多个记录或自动生成值的情况下使用。  
* 置空更新：将目标字段的值设置为空，清除其现有值。  
* 计算公式更新：基于公式或表达式计算目标字段的值。可以使用数学运算、逻辑操作、日期函数等来计算新的字段值，支持高级计算公式。  
3.添加：设置完成后点击 [添加]，一个触发器可添加多个更新规则。

**计算公式**  
&emsp;&emsp;计算公式可以实现复杂的字段值计算，甚至支持各种逻辑判断来计算字段值，但同时其也有一定的使用门槛。

**公式编辑器**  
&emsp;&emsp;公式编辑器仅支持数值类型的字段，如果是其他类型的字段，会自动切换到“高级计算公式”编辑器。请注意计算公式所返回的结果需要与“目标字段”类型匹配，例如目标字段为数字，否则可能导致触发器执行失败。  
&emsp;&emsp;在“更新方式”中选择“计算公式”，点击“计算公式”打开公式编辑器：  
![公式编辑器](https://mldocs.ks3-cn-beijing.ksyuncs.com/%E8%A7%A6%E5%8F%91%E5%99%A8%E9%80%BB%E8%BE%91/%E5%85%AC%E5%BC%8F%E7%BC%96%E8%BE%91%E5%99%A8.png)

标注的区域分别为：  
1.右侧区域为可选数值类型的字段，可基础该类型的字段进行数学运算。  
2.左侧区域为计算器操作。  

**高级计算公式**  

**高级计算公式要求您具备一定的编程基础，否则可能无法顺利进行。**  
&emsp;&emsp;高级计算公式的主要作用是满足用户特定的计算需求，因为不同的业务场景可能需要进行各种复杂的计算和数据转换。通过使用高级计算公式，用户可以根据自己的需求编写适合自己业务逻辑的代码，从而实现对数据的高度定制化处理。  
&emsp;&emsp;需要注意的是，由于高级计算公式允许用户编写自定义代码，建议在编写高级计算公式时，充分进行测试和验证，以确保计算逻辑的正确性和准确性。  
&emsp;&emsp;计算公式底层使用 Aviator 实现，因此您可以编写任何符合 Aviator Script 语法的代码来实现业务需求。  
&emsp;&emsp;高级计算公式中的字段变量也需要通过 {} 包裹，在公式执行时 系统会自动替换实际的字段值。

**更多函数**

TEXT  
作用：转换 ID（字段）值为文本  
语法：TEXT($ID, [$DEFAULT])  
示例：TEXT({id}) TEXT({id}, '没有值')  

ID  
作用：转换文本（字段）值为 ID。其中文本值可以是实体的自动编号字段或名称字段值（如匹配到多个仅返回第一个）  
语法：ID($TEXT, $ENTITY)  
示例：ID({no}, 'SalesOrder')  

CURRENTUSER  
作用：获取当前登录用户（ID）  
语法：CURRENTUSER()  
示例：CURRENTUSER()  

CURRENTBIZUNIT  
作用：获取当前登录用户的所在部门（ID）  
语法：CURRENTBIZUNIT()  
示例：CURRENTBIZUNIT()  

CURRENTDATE  
作用：获取当前日期时间  
语法：CURRENTDATE()  
示例：CURRENTDATE()  

CHINESEYUAN  
作用：转换数字（字段）为中文大写形式  
语法：CHINESEYUAN($NUMBER)  
示例：CHINESEYUAN({jine}) CHINESEYUAN(123)  

LOCATIONDISTANCE  
作用：计算两个 位置（字段）的直线距离（米）  
语法：LOCATIONDISTANCE($LOC1, $LOC2)  
示例：LOCATIONDISTANCE({qiyundi}, {mudidi}) LOCATIONDISTANCE({qiyundi}, {mudidi}) / 1000  

REQUEST  
作用：请求给定 URL 以获取结果  
语法：REQUEST($URL, [$DEFAULT])  
示例：REQUEST('http://xx/api/x?id=' + {id}, '')

### 字段聚合   
&emsp;&emsp;可以将与记录关联的子记录或相关记录的信息进行聚合，并填充到主记录的字段中。这可以帮助实现一对多关系中的汇总统计，例如将所有销售订单的总金额聚合到客户对象的总销售额字段中。  
&emsp;&emsp;字段聚合支持对数字字段的聚合计算，提供的聚合方式包括求和、计数、平均值以及计算公式等。

**配置触发器**
![字段聚合](https://mldocs.ks3-cn-beijing.ksyuncs.com/%E8%A7%A6%E5%8F%91%E5%99%A8%E9%80%BB%E8%BE%91/%E5%AD%97%E6%AE%B5%E8%81%9A%E5%90%88%E8%A7%A6%E5%8F%91%E5%99%A8%E9%85%8D%E7%BD%AE.png)

标注的区域分别为：  
1.目标实体：指定字段更新触发器要应用于的实体对象。源实体与目标实体通过 一对一引用 关联，只有存在关联关系的实体才能被选择。  
2.聚合规则：定义聚合触发器的规则和条件。不同类型的字段的聚合方式不同：  
数值类型的聚合方式：求和，计数，去重计数，平均值，最大值，最小值，计算公式；  
其他类型的聚合方式：计数，去重计数，拼接，去重拼接，计算公式。  
聚合方式：  
* 计数：对满足聚合数据条件的记录数进行计数。  
* 去重计数：对满足聚合数据条件的唯一记录数进行计数。  
* 拼接：将满足聚合数据条件的字段值按指定方式拼接在一起，形成一个聚合结果。  
* 去重拼接：将满足聚合数据条件的唯一字段值按指定方式拼接在一起，形成一个聚合结果。  
3.聚合数据条件：设置用于筛选满足聚合需求的数据条件。只有符合条件的数据才会被聚合，这些条件可以基于字段值、时间范围、逻辑运算符等来定义。例如，可以设置按特定产品类别的记录进行聚合，或者按特定日期范围的销售数据进行聚合。  
“聚合数据条件”与“附加过滤条件”的差异：  
“附加过滤条件”决定此触发器是否会被执行  
“聚合数据条件”决定数据聚合的范围  
例如某客户下有 10 笔订单需要聚合，且只聚合有效订单。若在“附加过滤条件”中排除无效订单，当一笔订单从“有效”修改为“无效”后，此触发器不会执行，从而导致本该聚合 9 笔订单的现在仍旧为 10 笔。

### 数据校验   
&emsp;&emsp;在保存或更新记录之前，检查指定字段的数值是否满足预定义的条件或规则。如果数据不符合条件，可以阻止保存或显示警告信息。例如，要求订单的付款金额不能超过客户的信用额度，可以通过数据校验来实现自动验证。

**配置触发器**
![数据校验](https://mldocs.ks3-cn-beijing.ksyuncs.com/%E8%A7%A6%E5%8F%91%E5%99%A8%E9%80%BB%E8%BE%91/%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C%E9%85%8D%E7%BD%AE%E8%A7%A6%E5%8F%91%E5%99%A8.png)

标注的区域分别为：    
1.校验条件：定义触发字段校验的条件。例如，当某个输入字段为空或格式不正确时触发校验。  
2.提示内容：设置校验失败时的提示信息，以便用户明确了解校验失败的原因。例如，您可以提示用户输入字段不能为空或者是一个有效的电子邮件地址等。内容支持字段变量。  
字段变量：字段变量以 {} 包裹字段内部标识的方式放置在内容中，字段变量会在提示时替换成相应的内容










